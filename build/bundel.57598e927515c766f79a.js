(()=>{"use strict";const e={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__save",inactiveButtonClass:"popup__save_invalid",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_visible"},t=class{constructor(e,t){this._config=e,this._formElement=t,this._saveButton=this._formElement.querySelector(this._config.submitButtonSelector),this._inputList=Array.from(this._formElement.querySelectorAll(this._config.inputSelector))}_showInputEror=e=>{this._errorElement=this._formElement.querySelector(`.${e.id}-error`),this._errorElement.classList.add(this._config.errorClass),this._errorElement.textContent=e.validationMessage,e.classList.add(this._config.inputErrorClass)};_hideInputEror=e=>{this._errorElement=this._formElement.querySelector(`.${e.id}-error`),this._errorElement.classList.remove(this._config.errorClass),this._errorElement.textContent="",e.classList.remove(this._config.inputErrorClass)};_checkInputValidity=e=>{e.validity.valid?this._hideInputEror(e):this._showInputEror(e)};_hasInvalidInput=e=>e.some((e=>!e.validity.valid));disableSubmitButton(){this._saveButton.classList.add(this._config.inactiveButtonClass),this._saveButton.setAttribute("disabled","disabled")}_deleteDisableButton(){this._formElement.querySelector(this._config.submitButtonSelector).classList.remove(this._config.inactiveButtonClass),this._formElement.querySelector(this._config.submitButtonSelector).removeAttribute("disabled")}_toggleButtonState=e=>{this._hasInvalidInput(e)?this.disableSubmitButton():this._deleteDisableButton()};_setEventListeners=()=>{this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState(this._inputList)}))}))};enableValidation(){this._setEventListeners()}},s=class{constructor(e){this._popupElement=document.querySelector(e),this._handleEscClose=this._handleEscClose.bind(this)}_handleEscClose(e){"Escape"===e.key&&this.close()}setEventListeners(){this._popupElement.addEventListener("click",(e=>{const t=e.target.classList;(t.contains("popup")||t.contains("popup__close"))&&this.close()}))}open(){this._popupElement.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popupElement.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}},i=class extends s{constructor(e,t){let{submitCallback:s}=t;super(e),this._submitCallback=s,this._form=this._popupElement.querySelector(".popup__form"),this._inputList=this._form.querySelectorAll(".popup__input"),this._buttonSubmit=this._popupElement.querySelector(".popup__save")}_getInputValues(){return this._formValues={},this._inputList.forEach((e=>{this._formValues[e.name]=e.value})),this._formValues}setInputValues(e){this._inputs.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submitCallback(this._getInputValues())}))}close(){super.close(),this._form.reset()}renderLoading(e){this.defaultText=this._buttonSubmit.textContent,this._buttonSubmit.textContent=e}finalLoading(){this._buttonSubmit.textContent=this.defaultText}},r=new class{constructor(e){let{baseUrl:t,headers:s}=e;this._baseUrl=t,this._headers=s}_failData(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}getUserInfo(){return fetch(`${this._baseUrl}/users/me`,{headers:this._headers}).then(this._failData)}getCardInfo(){return fetch(`${this._baseUrl}/cards`,{method:"GET",headers:this._headers}).then(this._failData)}editeProfile(e){let{name:t,about:s}=e;return fetch(`${this._baseUrl}/users/me `,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:t,about:s})}).then(this._failData)}editeAvatar(e){let{avatar:t}=e;return fetch(`${this._baseUrl}/users/me/avatar `,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:t})}).then(this._failData)}handleAddCardApi(e){let{name:t,link:s}=e;return fetch(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:t,link:s})}).then(this._failData)}deleteCard(e){return fetch(`${this._baseUrl}/cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._failData)}toggleLike(e,t){return t?fetch(`${this._baseUrl}/cards/${e}/likes`,{method:"DELETE",headers:this._headers}).then(this._failData):fetch(`${this._baseUrl}/cards/${e}/likes`,{method:"PUT",headers:this._headers}).then(this._failData)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-64",headers:{authorization:"8c48320c-2002-4b4d-ac4c-e334df1f77af","Content-Type":"application/json"}}),n=document.querySelector(".popup_edit-profile"),a=document.querySelector(".popup_avatar"),o=document.querySelector(".popup__input_type_name"),l=document.querySelector(".popup__input_type_about"),_=document.querySelector(".profile__edite"),h=document.querySelector("#card-item__template"),d=document.querySelector(".popup_card-form"),u=document.querySelector(".profile__add"),c=document.querySelector(".profile__avatar");let p;Promise.all([r.getUserInfo(),r.getCardInfo()]).then((e=>{let[t,s]=e;p=t._id,b.setUserInfo(t),m.rendersItem(s,p)}));const m=new class{constructor(e){let{items:t,renderer:s}=e;this._renderer=s,this._container=document.querySelector(".cards")}rendersItem(e,t){e.forEach((e=>{this._renderer(e,t)}))}addItemPrepend(e){this._container.prepend(e)}addItem(e){this._container.prepend(e)}}({items:[],renderer:e=>{m.addItem(f(e))}}),f=e=>{const t=new class{constructor(e,t,s,i,r,n){this._data=e,this._name=e.name,this._link=e.link,this._likes=e.likes,this._template=t,this._counter=e.likes.length,this.cardId=e._id,this._userId=s,this._ownerId=e.owner._id,this._alt=e.name,this._handleImageClick=i,this._handleTrashClick=r,this._handleToggleLike=n}_getTemplateCard(){return this._template.content.querySelector(".card-item").cloneNode(!0)}_setData(){return this._element=this._getTemplateCard(),this._title=this._newCard.querySelector(".card-item__title"),this._title.textContent=this._name,this._image=this._newCard.querySelector(".card-item__image"),this._image.src=this._link,this._image.alt=this._name,this._deleteCard=this._newCard.querySelector(".card-item__trash"),this._likeButton=this._newCard.querySelector(".card-item__like"),this._amountLikes=this._newCard.querySelector(".card-item__like-amount"),this._amountLikes.textContent=this._counter,this.isLiked(this._likes)&&(console.log("this.isLiked(this._likes)"),this._likeButton.classList.add("card-item__like_selected")),this._ownerId!==this._userId&&this._deleteCard.remove(),this._element}isLiked(e){return e.some((e=>{e._id,this._userId}))}toggleLike(e){let{likes:t}=e;this.likes=t,this._likeButton.classList.toggle("card-item__like_selected"),this._amountLikes.textContent=t.length}removeCard(){this._newCard.remove(),this._newCard=null}_handleOpenPopup(){this._handleImageClick(this._name,this._link)}_setEventListeners(){this._deleteCard=this._newCard.querySelector(".card-item__trash"),this._deleteCard.addEventListener("click",(()=>{this._handleTrashClick(this.cardId)})),this._likeButton=this._newCard.querySelector(".card-item__like"),this._likeButton.addEventListener("click",(()=>{this._handleToggleLike(this.cardId,this._likes)})),this._image=this._newCard.querySelector(".card-item__image"),this._image.addEventListener("click",(()=>{this._handleImageClick(this._name,this._link)}))}getView(){return this._newCard=this._getTemplateCard(),this._setEventListeners(),this._setData(),this._newCard}}(e,h,p,(function(e,t){L.open(e,t)}),(function(){C.openConfirmation(t)}),(function(){r.toggleLike(t.cardId,t.isLiked(t._likes)).then((e=>{t.toggleLike(e)})).catch((e=>{console.log(e)}))}));return t.getView()},b=new class{constructor(e){let{userName:t,userAbout:s,userAvatar:i}=e;this._userName=document.querySelector(t),this._userAbout=document.querySelector(s),this._userAvatar=document.querySelector(i)}getUserInfo(){return{name:this._userName.textContent,about:this._userAbout.textContent,avatar:this._userAvatar.src}}setUserInfo(e){let{name:t,about:s,avatar:i}=e;this._userName.textContent=t,this._userAbout.textContent=s,this._userAvatar.src=i}}({userName:".profile__name",userAbout:".profile__about",userAvatar:".profile__avatar"}),g=new i(".popup_edit-profile",{submitCallback:e=>{g.renderLoading("Сохранение..."),r.editeProfile(e).then((e=>{b.setUserInfo(e),v.finalLoading()})).then((()=>{g.close()})).catch((e=>{console.log(e)})).finally((()=>{g.finalLoading()}))}});g.setEventListeners(),_.addEventListener("click",(()=>{const e=b.getUserInfo();g.open(),o.value=e.name,l.value=e.about}));const v=new i(".popup_card-form",{submitCallback:e=>{v.renderLoading("Сохранение..."),r.handleAddCardApi(e).then((e=>{m.addItemPrepend(f(e))})).then((()=>{v.close()})).catch((e=>{console.log(e)})).finally((()=>{v.finalLoading();const e=document.querySelector(".popup__save_place_avatar");e.classList.add("popup__save_invalid"),e.disabled=!0}))}});u.addEventListener("click",(()=>{v.open()})),v.setEventListeners();const C=new class extends s{constructor(e,t){let{submitCallback:s}=t;super(e),this._buttonSubmit=this._popupElement.querySelector(".popup__save_place_yes"),this._submitCallback=s}openConfirmation(e){super.open(),this.cardId=e._id,this.card=e}setEventListeners(){super.setEventListeners(),this._buttonSubmit.addEventListener("click",(e=>{e.preventDefault(),this._submitCallback(this)}))}renderLoading(e){this.defaultText=this._buttonSubmit.textContent,this._buttonSubmit.textContent=e}finalLoading(){this._buttonSubmit.textContent=this.defaultText}}(".popup_confirm",{submitCallback:e=>{let{card:t}=e;C.renderLoading("Удаление..."),r.deleteCard(t.cardId).then((()=>{t.removeCard()})).then((()=>{C.close()})).catch((e=>{console.log(e)})).finally((()=>{C.finalLoading()}))}});C.setEventListeners();const E=new i(".popup_avatar",{submitCallback:e=>{E.renderLoading("Сохранение..."),r.editeAvatar(e).then((e=>{b.setUserInfo(e)})).then((()=>{E.close()})).catch((e=>{console.log(e)})).finally((()=>{E.finalLoading();const e=document.querySelector(".popup__save_place_card-form");e.classList.add("popup__save_invalid"),e.disabled=!0}))}});c.addEventListener("click",(()=>{E.open()})),E.setEventListeners();const L=new class extends s{constructor(e){super(e),this._img=this._popupElement.querySelector(".popup__img"),this._name=this._popupElement.querySelector(".popup__tag")}open(e,t){super.open(),console.log(e,t),this._img.alt=e,this._name.textContent=e,this._img.src=t}}(".popup_img-zoom");L.setEventListeners(),new t(e,n).enableValidation(),new t(e,d).enableValidation(),new t(e,a).enableValidation()})();